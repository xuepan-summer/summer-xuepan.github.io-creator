---
title: "浅谈事务"
date: 2020-11-17T14:43:30+08:00
draft: false
---

### 浅谈事务(transaction)

- 事务的概念：

事务是DBMS（可靠数据库管理系统）中最基本的单位，通俗来讲就是要做的事情。包括四大特性（ACID）：Atomicity 原子性、Consistency 一致性、Isolation 隔离性、Durability持久性。

- 事务四大特性：

1.  原子性：事务是不可分割的整体，事务里的操作要么都实现要么都不实现，体现了原子性。

eg：甲给乙转钱，乙收钱，要么整个过程成功（甲扣钱，乙收钱），要么整个过程不成功（甲未扣钱，乙未收钱）。

2. 一致性：甲给乙转的钱和乙收到的钱是一致的。整个过程是维持平衡的。

3. 隔离性：事务之间是隔离的，即使不同事务处理相同的数据，也要有修改隔离。（即修改也是相互独立的）
4. 持久性：事务一旦提交，将持久保存在数据库中。

+ 事务高并发产生问题：

1. 脏读(Dirty Read)：事务B读到了事务A已修改但未提交的数据。如果事务A提交失败，那么这B就读到了脏数据。

2. 不可重复读(Unrepeatable Read)：一个事务多次查询同一数据，结果不一致。因为受到了其他事务的干扰。

3. 幻读(Phantom Read)：例如事务A将1改成2，事务B插入了数据1，那么还是可以选出来值为1的数据

   **三者区别**

   ① 脏读&不可重复读：脏读是因为修改未提交，但不可重复读是因为有别的事务插手，读取了其他事务提交的数据，所以数据不一致

   ② 不可重复读&幻读：不可重复读针对同一数据项，幻读针对一批数据整体（比如数据条数）

   针对以上问题，隔离性就起了作用，如何使事务之间隔离起来，互不影响？因此产生了事务隔离级别。

+ 事务隔离级别：

×表示不会出现，√表示可能会出现

| 事务隔离级别     | 脏读 | 不可重复读 | 幻读 |
| :--------------- | :--: | :--------: | :--: |
| Read uncommitted |  √   |     √      |  √   |
| Read committed   |  ×   |     √      |  √   |
| Repeatable read  |  ×   |     ×      |  √   |
| Serializable     |  ×   |     ×      |  ×   |

① Read uncommitted (读未提交)：最低的事务隔离级别，一个事务还没提交时，它做的变更就能被别的事务看到。

 ② Read committed (读已提交)：保证一个事物**提交后**才能被另外一个事务读取。另外一个事务不能读取该事物未提交的数据。  

大多数数据库的默认级别就是 Read committed，比如 Sql Server , Oracle。 

 ③ Repeatable read（可重复读，默认级别）：多次读取同一范围的数据会返回第一次查询的快照，即使其他事务对该数据做了更新修改。事务在执行期间看到的数据前后必须是一致的。

④ Serializable（串行化）：花费最高代价但最可靠的事务隔离级别。“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。

+ 事务的传播机制

以Spring为例，Spring事务机制主要包括<u>声明式事务</u>和<u>编程式事务</u>，声明式事务更广泛使用一些，因此以此为例。

Spring声明式事务让我们不需要再去处理获得连接、关闭连接、事务提交、事务回滚等繁琐的操作。其中一个重要的概念是事务属性，事务属性通常由事务的传播行为，事务的隔离级别，事务的超时值和事务只读标志组成。

Spring在TransactionDefinition接口中定义了七个事务传播行为：

① **propagation_requierd**：如果当前没有事务，就新建一个事务，如果已存在一个事务中，加入到这个事务中，这是最常见的选择。

② **propagation_supports**：支持当前事务，如果没有当前事务，就以非事务方法执行。

③ **propagation_mandatory**：使用当前事务，如果没有当前事务，就抛出异常。

④ **propagation_required_new**：新建事务，如果当前存在事务，把当前事务挂起。

⑤ **propagation_not_supported**：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。

⑥ **propagation_never**：以非事务方式执行操作，如果当前事务存在则抛出异常。

⑦ **propagation_nested**：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与propagation_required类似的操作

具体实现可参照博客https://www.cnblogs.com/myseries/p/10800430.html

对于不同的传播行为讲的很清楚，着重看第4、7种情况
